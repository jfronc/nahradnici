---
title: "Poslanci a n√°hradn√≠ci"
format:
  html:
    page-layout: full
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
xfun::pkg_attach("dplyr", "reactable", "crosstalk")

cz_date <- function(x) {
  x <- format(x, "%e. %m. %Y") |>
    stringr::str_replace("\\s0", " ")
  return(x)
}

parties <- readRDS(here::here("psp/data/parties.rds"))
candidates <- readRDS(here::here("psp/data/candidates.rds")) |>
  mutate(
    prefhl = paste0("<div>", format(POCHLASU, big.mark = " "), "<small> (", POCPROC, " %)</small></div>")
    ) |>
  select(JMENO, PRIJMENI, VEK, POVOLANI, PSTRANA, since, until, prefhl, VOLKRAJ, NAZVOLKRAJ, KSTRANA, NAZ_STR, state) |>
  left_join(parties, by = "PSTRANA") |>
  select(-c(PSTRANA, NAZEV_STRP))

newest <- candidates$since |> max(na.rm = TRUE)
```

**Posledn√≠ zmƒõna ve slo≈æen√≠ PSP:** `r cz_date(newest)`
```{r until}
pull_name <- function(df, side, icon, date) {
  df <- df |>
    ungroup() |>
    filter({{ side }} == date) |>
    mutate(line = paste0(icon, " ", JMENO, " ", PRIJMENI, " (", NAZ_STR, ")")) |>
    pull(line)
  return(df)
}

pull_name(candidates, until, "üö´", newest) |> cat()
```

```{r since}
pull_name(candidates, since, "‚û°Ô∏è", newest) |> cat()

```

```{r table}
# Create shared data object for Crosstalk filters
shared_candidates <- SharedData$new(candidates)

# Create linked filters
region_filter <- filter_select(
  id = "region",
  label = "Volebn√≠ kraj",
  shared_candidates,
  group = ~NAZVOLKRAJ,
  multiple = FALSE
)

party_filter <- filter_select(
  id = "party",
  label = "Volebn√≠ strana",
  shared_candidates,
  group = ~NAZ_STR,
  multiple = FALSE
)

# Create interactive reactable table
candidate_table <- reactable(
  shared_candidates,
  columns = list(
    JMENO = colDef(name = "Jm√©no"),
    PRIJMENI = colDef(name = "P≈ô√≠jmen√≠"),
    VEK = colDef(name = "Vƒõk", width = 45),
    POVOLANI = colDef(name = "Povol√°n√≠", width = 400),
    ZKRATKAP8 = colDef(name = "Pol. p≈ô√≠sl.", width = 100),
    prefhl = colDef(name = "Pref. hl.", width = 130, html = TRUE),
    since = colDef(name = "Mand√°t od", cell = cz_date, width = 100),
    until = colDef(name = "Mand√°t do", cell = cz_date, width = 100),
    VOLKRAJ = colDef(show = FALSE),
    NAZVOLKRAJ = colDef(show = FALSE),
    KSTRANA = colDef(show = FALSE),
    NAZ_STR = colDef(show = FALSE),
    state = colDef(show = FALSE)
  ),
  pagination = FALSE,
  highlight = TRUE,
  bordered = TRUE,
#  compact = TRUE,
  rowStyle = JS("
    function(rowInfo) {
      if (rowInfo.row.state == 11) {
        return { backgroundColor: '#e8f5e9' }  // poslanec od zaƒç√°tku
      } else if (rowInfo.row.state == 12) {
        return { backgroundColor: '#fcf988' }  // poslanec‚Äìn√°hradn√≠k
      } else if (rowInfo.row.state == 3) {
        return { backgroundColor: '#ffb8b0' }  // b√Ωval√Ω poslanec
      } else if (rowInfo.row.state == 0) {
        return { textDecoration: 'line-through' }  // vy≈°krtnut√Ω
      } else {
        return {}
      }
    }
  ")
)

# Arrange filters above the table
htmltools::tagList(
  htmltools::h4("Vyberte kraj a stranu"),
  region_filter,
  party_filter,
  candidate_table
)

```
